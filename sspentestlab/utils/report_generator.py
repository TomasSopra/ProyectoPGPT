import os
import docx
from docx2pdf import convert
from datetime import datetime
import json

def replace_placeholder(doc, placeholder, replacement):
    """Replace placeholder text in the Word document."""
    
    # Helper function to replace in a paragraph
    def replace_in_paragraph(para, placeholder, replacement):
        if placeholder in para.text:
            # Debugging
            # print(f"Found placeholder '{placeholder}' in paragraph: {para.text}")
            # Join all runs together to make a single string
            full_text = ''.join([run.text for run in para.runs])
            # Replace the placeholder in the full text
            full_text = full_text.replace(placeholder, replacement)
            # Clear all runs in the paragraph
            for run in para.runs:
                run.text = ''
            # Redistribute the full text into runs
            para.runs[0].text = full_text
    
    # Process paragraphs in the document
    for para in doc.paragraphs:
        replace_in_paragraph(para, placeholder, replacement)

    # Process table cells
    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                for para in cell.paragraphs:
                    replace_in_paragraph(para, placeholder, replacement)



def json_to_content(json_data):
    """Convert JSON data to formatted content for Word document."""
    
    commands_executed = '\n'.join(f"- {cmd}" for cmd in json_data.get('commands_executed', []))
    summary_results = (
        f"- **Total Commands Executed:** {json_data['summary_results'].get('total_commands', 0)}\n"
        f"- **Successful Commands:** {json_data['summary_results'].get('successful_commands', 0)}\n"
        f"- **Failed Commands:** {json_data['summary_results'].get('failed_commands', 0)}\n")
    vulnerabilities_found = (
        "No vulnerabilities found." if not json_data.get('vulnerabilities_found', []) else
        '\n'.join(f"- {vuln}" for vuln in json_data['vulnerabilities_found']))
    additional_information = json_data.get('additional_information', 'No additional information.')

    return commands_executed, summary_results, vulnerabilities_found, additional_information



def gpt_to_pdf(json_data_str, output_filename):
    """Convert JSON data to a PDF using a Word template."""
    
    # ensure the JSON string is correctly formatted.
    if not json_data_str.strip():
        print("Invalid JSON input format")
        return
    
    # remove the 'json' keyword and backticks if they exist.
    if json_data_str.strip().startswith('```json'):
        json_data_str = json_data_str.strip()[7:]
    if json_data_str.strip().endswith('```'):
        json_data_str = json_data_str.strip()[:-3]

    # print the cleaned JSON string for debugging.
    # print(f"Cleaned JSON input: {json_data_str.strip()}")

    # parse the JSON string.
    try:
        json_data = json.loads(json_data_str.strip())
    except json.JSONDecodeError as e:
        print(f"Error decoding JSON: {e}")
        return

    # extract content from JSON.
    commands_executed, summary_results, vulnerabilities_found, additional_information = json_to_content(json_data)

    # load the Word template.
    doc = docx.Document('/usr/utils/template/template.docx')
    # Replace placeholders with actual content
    replace_placeholder(doc, '{{title}}', str(output_filename.strip('.pdf')))
    replace_placeholder(doc, '{{date}}', datetime.now().strftime('%Y-%m-%d'))
    replace_placeholder(doc, '{{commands_executed}}', commands_executed)
    replace_placeholder(doc, '{{summary_results}}', summary_results)
    replace_placeholder(doc, '{{vulnerabilities_found}}', vulnerabilities_found)
    replace_placeholder(doc, '{{additional_information}}', additional_information)

    # save the updated document.
    temp_docx_path = './logs/reports/temp_report.docx'
    os.makedirs(os.path.dirname(temp_docx_path), exist_ok=True)
    doc.save(temp_docx_path)
    
    # convert the Word document to PDF.
    output_pdf_path = os.path.join('./logs/reports', output_filename + '.pdf')
    convert(temp_docx_path, output_pdf_path)
    os.remove(temp_docx_path)
